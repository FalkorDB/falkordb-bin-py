name: Publish Platform Wheels

on:
  workflow_dispatch:
    inputs:
      package_version:
        description: "falkordb-bin version (should match falkordb)"
        required: true
        default: "1.4.0"
      redis_version:
        description: "Redis version to build"
        required: true
        default: "8.2.3"
      falkordb_version:
        description: "FalkorDB release tag"
        required: true
        default: "v4.16.3"
  release:
    types: [published]

permissions:
  contents: read
  id-token: write

jobs:
  build_wheels:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux-x64
            cibw_archs: x86_64
            falkordb_asset: falkordb-x64.so
          - os: ubuntu-24.04-arm
            platform: linux-arm64
            cibw_archs: aarch64
            falkordb_asset: falkordb-arm64v8.so
          - os: macos-14
            platform: macos-arm64
            cibw_archs: arm64
            falkordb_asset: falkordb-macos-arm64v8.so
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v6

      - name: Set package version from input
        if: github.event_name == 'workflow_dispatch'
        run: |
          python - <<'PY'
          import pathlib
          import re

          version = "${{ inputs.package_version }}"
          p = pathlib.Path("pyproject.toml")
          text = p.read_text(encoding="utf-8")
          text = re.sub(r'(?m)^version\s*=\s*"[^"]+"', f'version = "{version}"', text)
          p.write_text(text, encoding="utf-8")
          print(f"Updated package version to {version}")
          PY

      - name: Set build env versions
        run: |
          echo "REDIS_VERSION=${{ github.event.inputs.redis_version || '8.2.3' }}" >> "$GITHUB_ENV"
          echo "FALKORDB_VERSION=${{ github.event.inputs.falkordb_version || 'v4.16.3' }}" >> "$GITHUB_ENV"

      - uses: pypa/cibuildwheel@v3.3.1
        env:
          CIBW_ARCHS: ${{ matrix.cibw_archs }}
          CIBW_ENVIRONMENT: >-
            REDIS_VERSION=${{ env.REDIS_VERSION }}
            FALKORDB_VERSION=${{ env.FALKORDB_VERSION }}
            FALKORDB_ASSET=${{ matrix.falkordb_asset }}
          CIBW_ENVIRONMENT_MACOS: >-
            MACOSX_DEPLOYMENT_TARGET=11.0

      - uses: actions/upload-artifact@v7
        with:
          name: wheels-${{ matrix.platform }}
          path: ./wheelhouse/*.whl

  smoke_test:
    needs: [build_wheels]
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux-x64
          - os: ubuntu-24.04-arm
            platform: linux-arm64
          - os: macos-14
            platform: macos-arm64
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - uses: actions/download-artifact@v7
        with:
          name: wheels-${{ matrix.platform }}
          path: dist

      - name: Install wheel
        run: |
          python -m pip install --upgrade pip
          python -m pip install dist/*cp312*.whl

      - name: Smoke test binaries
        run: |
          python - <<'PY'
          import os
          import subprocess
          import falkordb_bin

          redis_server = falkordb_bin.get_redis_server()
          module_path = falkordb_bin.get_falkordb_module()

          assert os.path.exists(redis_server), redis_server
          assert os.path.exists(module_path), module_path
          assert os.path.getsize(redis_server) > 0, redis_server
          assert os.path.getsize(module_path) > 0, module_path

          print("redis-server:", redis_server)
          print("falkordb module:", module_path)
          subprocess.run([redis_server, "--version"], check=True)
          PY

  publish:
    needs: [build_wheels, smoke_test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v7
        with:
          pattern: wheels-*
          path: dist
          merge-multiple: true

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          skip-existing: true
          verbose: true
          attestations: false
